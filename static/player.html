<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>File Details</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <style>
        /* Always Dark Mode */
        html, body {
            margin: 0;
            background-color: #000 !important;
            color: #f1f1f1 !important;
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }

        a, button { color: inherit; }

        .wrapper {
            max-width: 900px;
            margin: 0 auto;
            padding: 1.5rem 1rem;
            text-align: center;
        }

        /* Player container (full width of wrapper; no stray background) */
        .player-box {
            width: 100%;
            background: #000;
            overflow: hidden;
            display: flex;
            justify-content: center;
            border-radius: 10px;
        }

        .player-aspect {
            width: 100%;
            aspect-ratio: 16/9;
            position: relative;
            max-width: 100%;
        }

        .artplayer-app { width: 100%; height: 100%; }

        .loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
        }

        /* Info */
        .info-container {
            margin-top: 1.2rem;
            background: #0f0f0f;
            padding: 1.2rem;
            border-radius: .5rem;
            border: 1px solid #222;
        }

        #file-name {
            font-size: 1.25rem;
            margin: 0;
            /* allow long filenames to wrap */
            white-space: normal;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        #file-size { margin-top: .3rem; color: #aaa; }

        .recommend-note {
            margin-top: .7rem;
            font-size: .9rem;
            color: #4dd0e1;
            text-decoration: underline;
            cursor: pointer;
            margin-bottom: 0;
        }

        .platform-box {
            background: #0d0d0d;
            border: 1px solid #222;
            padding: .9rem;
            border-radius: .35rem;
            margin-top: 1rem;
            text-align: left;
        }

        .platform-box h5 { font-weight: 600; margin-bottom: .6rem; color: #e0e0e0; }

        .button-group {
            display:flex;
            flex-wrap:wrap;
            gap:.5rem;
            margin-bottom:.7rem;
        }

        .btn-info { background-color: #0565ff; border-color:#0565ff; }
        .btn-secondary { background-color:#333; border-color:#555; color:#fff; }

        @media (max-width: 576px) {
            .wrapper { padding: 1rem .6rem; }
        }
    </style>
</head>
<body>
    <div class="wrapper">

        <!-- Player -->
        <div class="player-box">
            <div class="player-aspect">
                <div class="artplayer-app">
                    <div class="loading" id="loading">Loading video...</div>
                </div>
            </div>
        </div>

        <!-- Info -->
        <div class="info-container">
            <h3 id="file-name" title=""></h3>
            <p id="file-size"></p>

            ðŸ’¡ For Subtitle and Dual Audio Support, use a dedicated player like MX Player or VLC.
            <p class="recommend-note" data-toggle="collapse" data-target="#playerOptions">Tap to know more</p>

            <div id="playerOptions" class="collapse">

                <!-- Android -->
                <div class="platform-box">
                    <h5>For Android</h5>
                    <div class="button-group">
                        <a id="mx-player-btn" class="btn btn-info" href="#" target="_blank">MX Player</a>
                        <a id="mx-pro-btn" class="btn btn-info" href="#" target="_blank">MX Player Pro</a>
                        <a id="vlc-btn" class="btn btn-info" href="#" target="_blank">VLC</a>
                    </div>
                </div>

                <!-- iOS/PC -->
                <div class="platform-box">
                    <h5>For iOS / Windows / Linux</h5>

                    <div class="button-group">
                        <a class="btn btn-info" href="https://www.videolan.org/vlc/#download" target="_blank">Download VLC</a>
                    </div>

                    <div class="button-group">
                        <button id="copy-stream-link-btn" class="btn btn-secondary">Copy Stream Link</button>
                    </div>

                    <ol>
                        <li>Copy the stream link.</li>
                        <li>Open VLC.</li>
                        <li>Select "Open Network Stream".</li>
                        <li>Paste & play.</li>
                    </ol>
                </div>

            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Player script with subtitle + fullscreen + wake-lock + resume -->
    <script>
    (async () => {
        const rawFile = window.location.pathname.split('/').pop() || '';
        const encoded = encodeURIComponent(rawFile);
        const streamUrl = `/stream/${encoded}`;
        const loadingEl = document.getElementById('loading');
        const fileNameEl = document.getElementById('file-name');

        // Insert zero-width space after dots so long dotted names can break nicely
        function makeBreakableName(name) {
            if (!name) return '';
            return name.replace(/\./g, '.\u200B');
        }

        const setButtonLinks = () => {
            const full = `${location.origin}/stream/${encoded}`;
            const mx = document.getElementById('mx-player-btn');
            const mxp = document.getElementById('mx-pro-btn');
            const vlc = document.getElementById('vlc-btn');

            if (mx) mx.href = `/play/mx/${encoded}`;
            if (mxp) mxp.href = `/play/mxpro/${encoded}`;
            if (vlc) vlc.href = `/play/vlc/${encoded}`;

            const copyBtn = document.getElementById('copy-stream-link-btn');
            if (copyBtn) {
                copyBtn.onclick = () => {
                    navigator.clipboard.writeText(full).then(() => {
                        const prev = copyBtn.innerText;
                        copyBtn.innerText = 'Copied!';
                        setTimeout(() => (copyBtn.innerText = prev), 2000);
                    }).catch(() => {
                        // fallback: select prompt
                        alert('Could not copy automatically. URL: ' + full);
                    });
                };
            }
        };

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = src;
                s.async = true;
                s.onload = resolve;
                s.onerror = reject;
                document.head.appendChild(s);
            });
        }

        // WakeLock / NoSleep handling
        let wakeLock = null;
        let noSleep = null;
        const requestWakeLock = async () => {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => (wakeLock = null));
                } catch (err) { console.warn('WakeLock failed', err); }
            } else if (noSleep) {
                try { noSleep.enable(); } catch (e) { console.warn('NoSleep enable failed', e); }
            }
        };
        const releaseWakeLock = async () => {
            if (wakeLock) {
                try { await wakeLock.release(); } catch { }
                wakeLock = null;
            }
            if (noSleep) {
                try { noSleep.disable(); } catch { }
            }
        };
        const attachWakeLockHandlers = (player) => {
            try {
                player.on('play', async () => await requestWakeLock());
                player.on('pause', async () => await releaseWakeLock());
                document.addEventListener('visibilitychange', async () => {
                    const videoEl = document.querySelector('.artplayer-app video');
                    const isPlaying = videoEl && !videoEl.paused && !videoEl.ended;
                    if (document.visibilityState === 'visible' && isPlaying && !wakeLock) {
                        await requestWakeLock();
                    } else {
                        await releaseWakeLock();
                    }
                });
                window.addEventListener('beforeunload', async () => await releaseWakeLock());
            } catch (e) { /* ignore */ }
        };

        async function initPlayer(details) {
            loadingEl.style.display = 'none';

            // load artplayer and nosleep
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/artplayer/5.1.1/artplayer.js');
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.12.0/NoSleep.min.js');

            // init NoSleep if available
            if (typeof NoSleep !== 'undefined') {
                try { noSleep = new NoSleep(); } catch (e) { /* ignore */ }
            }

            // build options
            const opts = {
                container: '.artplayer-app',
                url: streamUrl,
                title: details.file_name || decodeURIComponent(rawFile),
                autoplay: false,
                autoSize: true,
                playsInline: true,
                fullscreen: true,
                miniProgressBar: true,
                fastForward: true,
                subtitle: {}
            };

            if (details.subtitle_url) {
                opts.subtitle = {
                    url: details.subtitle_url,
                    type: details.subtitle_type || 'srt',
                    encoding: details.subtitle_encoding || 'utf-8',
                    default: true,
                    escape: false,
                    style: { color: '#FFFFFF', fontSize: '18px', fontWeight: 'bold' },
                };
            } else {
                // keep subtitle empty; Artplayer won't show subtitle controls if no url
                delete opts.subtitle;
            }

            const player = new Artplayer(opts);

            // attach wakelock handlers
            attachWakeLockHandlers(player);

            // resume playback
            const resumeKey = `resumeTime_${encoded}`;
            const savedTime = parseFloat(localStorage.getItem(resumeKey) || '0');

            player.on('video:loadedmetadata', () => {
                try {
                    if (savedTime > 0 && savedTime < player.duration - 3) {
                        player.currentTime = savedTime;
                        // console.log('resumed at', savedTime);
                    }
                } catch (e) { /* ignore */ }
            });

            player.on('timeupdate', () => {
                try {
                    if (!player.video.paused && !player.video.ended) {
                        localStorage.setItem(resumeKey, player.currentTime);
                    }
                } catch (e) { /* ignore */ }
            });

            player.on('ended', () => localStorage.removeItem(resumeKey));
        }

        // page wiring
        setButtonLinks();

        try {
            const res = await fetch(`/details/${encoded}`);
            if (!res.ok) throw new Error('Failed to fetch details');
            const data = await res.json();

            // make filename breakable but keep original in title
            const originalName = data.file_name || rawFile;
            const breakable = makeBreakableName(originalName);
            fileNameEl.innerText = breakable;
            fileNameEl.title = originalName;

            document.getElementById('file-size').innerText = data.file_size || '';

            await initPlayer(data);
        } catch (err) {
            // fallback
            const fallback = makeBreakableName(rawFile);
            fileNameEl.innerText = fallback;
            fileNameEl.title = rawFile;
            await initPlayer({});
        }
    })();
    </script>
</body>
</html>
