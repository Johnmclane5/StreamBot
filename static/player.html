<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>File Details</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <style>
        /* Always Dark Mode */
        html, body {
            margin: 0;
            background-color: #000 !important;
            color: #f1f1f1 !important;
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }
        a, button { color: inherit; }

        .wrapper {
            max-width: 900px;
            margin: 0 auto;
            padding: 1.5rem 1rem;
            text-align: center;
        }

        /* Player */
        .player-box {
            width: 100%;
            background: #000;
            overflow: hidden;
            display: flex;
            justify-content: center;
            border-radius: 10px;
        }

        .player-aspect {
            width: 100%;
            aspect-ratio: 16/9;
            position: relative;
            max-width: 100%;
        }

        .artplayer-app { width: 100%; height: 100%; }

        #queue-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 1rem;
            z-index: 10;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden { display: none; }

        .loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
        }

        /* Info */
        .info-container {
            margin-top: 1.2rem;
            background: #0f0f0f;
            padding: 1.2rem;
            border-radius: .5rem;
            border: 1px solid #222;
        }

        #file-name {
            font-size: 1.25rem;
            margin: 0;
            white-space: normal;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        #file-size { margin-top: .3rem; color: #aaa; }

        .recommend-note {
            margin-top: .7rem;
            font-size: .9rem;
            color: #4dd0e1;
            text-decoration: underline;
            cursor: pointer;
            margin-bottom: 0;
        }

        .platform-box {
            background: #0d0d0d;
            border: 1px solid #222;
            padding: .9rem;
            border-radius: .35rem;
            margin-top: 1rem;
            text-align: left;
        }

        .platform-box h5 { font-weight: 600; margin-bottom: .6rem; color: #e0e0e0; }

        .button-group {
            display:flex;
            flex-wrap:wrap;
            gap:.5rem;
            margin-bottom:.7rem;
            justify-content: flex-start;
        }

        .btn-info { background-color: #0565ff; border-color:#0565ff; color: #fff; }
        .btn-secondary { background-color:#333; border-color:#555; color:#fff; }

        @media (max-width: 576px) {
            .wrapper { padding: 1rem .6rem; }
        }
        
        /* Keep subtitles visible even when controls are hidden */
        .art-subtitle {
            bottom: 50px !important;
            opacity: 1 !important;
            display: block !important;
            visibility: visible !important;
            pointer-events: none !important;
            transition: none !important;
        }
    </style>
</head>
<body>
    <div class="wrapper">

        <!-- Player -->
        <div class="player-box">
            <div class="player-aspect">
                <div class="artplayer-app">
                    <div class="loading" id="loading">Loading video...</div>
                </div>
                <div id="queue-overlay" class="hidden">
                    <div class="spinner"></div>
                    <p>The server is busy, your stream is in a queue. Please wait, we will retry shortly.</p>
                </div>
            </div>
        </div>

        <!-- Info -->
        <div class="info-container">
            <h3 id="file-name" title=""></h3>
            <p id="file-size"></p>

            ðŸ’¡ For Subtitle and Dual Audio Support, use a dedicated player like MX Player or VLC.
            <p class="recommend-note" data-toggle="collapse" data-target="#playerOptions">Tap to know more</p>

            <div id="playerOptions" class="collapse">

                <!-- Android -->
                <div class="platform-box">
                    <h5>For Android</h5>
                    <div class="button-group">
                        <a id="mx-player-btn" class="btn btn-info" href="#" target="_blank">MX Player</a>
                        <a id="mx-pro-btn" class="btn btn-info" href="#" target="_blank">MX Player Pro</a>
                        <a id="vlc-btn" class="btn btn-info" href="#" target="_blank">VLC</a>
                    </div>
                </div>

                <!-- iOS / PC -->
                <div class="platform-box">
                    <h5>For iOS / Windows / Linux</h5>

                    <div class="button-group">
                        <a class="btn btn-info" href="https://www.videolan.org/vlc/#download" target="_blank">Download VLC</a>
                    </div>

                    <div class="button-group">
                        <button id="copy-stream-link-btn" class="btn btn-secondary">Copy Stream Link</button>
                    </div>

                    <ol>
                        <li>Copy the stream link.</li>
                        <li>Open VLC.</li>
                        <li>Select "Open Network Stream".</li>
                        <li>Paste & play.</li>
                    </ol>
                </div>

            </div>
        </div>

    </div>

    <!-- Bootstrap JS (needed for collapse) -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Player + subtitle + wake-lock + nosleep + resume -->
    <script>
    (async () => {
        const rawFile = window.location.pathname.split('/').pop() || '';
        const encoded = encodeURIComponent(rawFile);
        const streamUrl = `/stream/${encoded}`;
        const loadingEl = document.getElementById('loading');
        const fileNameEl = document.getElementById('file-name');
        const queueOverlay = document.getElementById('queue-overlay');

        // make breakable filename (zero-width after dots)
        function makeBreakableName(name) {
            if (!name) return '';
            return name.replace(/\./g, '.\u200B');
        }

        function setButtonLinks() {
            const full = `${location.origin}/stream/${encoded}`;
            const mx = document.getElementById('mx-player-btn');
            const mxp = document.getElementById('mx-pro-btn');
            const vlc = document.getElementById('vlc-btn');

            if (mx) mx.href = `/play/mx/${encoded}`;
            if (mxp) mxp.href = `/play/mxpro/${encoded}`;
            if (vlc) vlc.href = `/play/vlc/${encoded}`;

            const copyBtn = document.getElementById('copy-stream-link-btn');
            if (copyBtn) {
                copyBtn.onclick = () => {
                    navigator.clipboard.writeText(full).then(() => {
                        const prev = copyBtn.innerText;
                        copyBtn.innerText = 'Copied!';
                        setTimeout(() => (copyBtn.innerText = prev), 2000);
                    }).catch(() => {
                        alert('Could not copy automatically. URL: ' + full);
                    });
                };
            }
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = src;
                s.async = true;
                s.onload = resolve;
                s.onerror = reject;
                document.head.appendChild(s);
            });
        }

        // WakeLock / NoSleep
        let wakeLock = null;
        let noSleep = null;
        const requestWakeLock = async () => {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => (wakeLock = null));
                } catch (err) { console.warn('WakeLock request failed:', err); }
            } else if (noSleep) {
                try { noSleep.enable(); } catch (e) { console.warn('NoSleep enable failed:', e); }
            }
        };
        const releaseWakeLock = async () => {
            if (wakeLock) {
                try { await wakeLock.release(); } catch {}
                wakeLock = null;
            }
            if (noSleep) {
                try { noSleep.disable(); } catch {}
            }
        };
        const attachWakeLockHandlers = (player) => {
            try {
                player.on('play', async () => await requestWakeLock());
                player.on('pause', async () => await releaseWakeLock());
                document.addEventListener('visibilitychange', async () => {
                    const videoEl = document.querySelector('.artplayer-app video');
                    const isPlaying = videoEl && !videoEl.paused && !videoEl.ended;
                    if (document.visibilityState === 'visible' && isPlaying && !wakeLock) {
                        await requestWakeLock();
                    } else {
                        await releaseWakeLock();
                    }
                });
                window.addEventListener('beforeunload', async () => await releaseWakeLock());
            } catch (e) { /* ignore */ }
        };

        async function checkStreamAndPlay(details) {
            try {
                const res = await fetch(streamUrl, { method: 'HEAD' });
                if (res.status === 503) {
                    // Server is busy, show queue message and retry after 30 seconds
                    queueOverlay.classList.remove('hidden');
                    loadingEl.style.display = 'none';
                    setTimeout(() => checkStreamAndPlay(details), 30000);
                } else if (res.ok) {
                    // Stream is available, hide queue and start player
                    queueOverlay.classList.add('hidden');
                    await initPlayer(details);
                } else {
                    // Handle other errors
                    console.error('Stream check failed with status:', res.status);
                    loadingEl.innerText = `Error: Could not load video (${res.status})`;
                }
            } catch (err) {
                console.error('Error checking stream:', err);
                loadingEl.innerText = 'Error: Could not connect to the server.';
            }
        }

        async function initPlayer(details) {
            loadingEl.style.display = 'none';

            // load Artplayer + NoSleep
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/artplayer/5.1.1/artplayer.js');
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.12.0/NoSleep.min.js');

            if (typeof NoSleep !== 'undefined') {
                try { noSleep = new NoSleep(); } catch (e) { /* ignore */ }
            }

            // build options
            const options = {
                container: '.artplayer-app',
                url: streamUrl,
                title: details.file_name || decodeURIComponent(rawFile),
                autoplay: false,
                autoSize: true,
                autoOrientation: true,
                playsInline: true,
                fullscreen: true,
                fastForward: true,
                subtitle: {}
            };

            // If backend provides subtitle_url, set subtitle config
            if (details.subtitle_url) {
                options.subtitle = {
                    url: details.subtitle_url,
                    type: details.subtitle_type || 'srt',
                    encoding: details.subtitle_encoding || 'utf-8',
                    default: true,
                    escape: false,
                };
            }
            
            const player = new Artplayer(options);

            // attach wake lock behavior
            attachWakeLockHandlers(player);

            // resume playback support
            const resumeKey = `resumeTime_${encoded}`;
            const saved = parseFloat(localStorage.getItem(resumeKey) || '0');

            player.on('video:loadedmetadata', () => {
                try {
                    if (saved > 0 && saved < player.duration - 3) {
                        player.currentTime = saved;
                    }
                } catch (e) { /* ignore */ }
            });

            const saveTime = () => {
                try {
                    if (player.currentTime > 0 && !player.video.ended) {
                        localStorage.setItem(resumeKey, player.currentTime);
                    }
                } catch (e) {
                    console.warn('Failed to save playback time:', e);
                }
            };

            // Save progress on page hide or when visibility changes
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') {
                    saveTime();
                }
            });
            window.addEventListener('pagehide', saveTime);


            player.on('ended', () => {
                localStorage.removeItem(resumeKey);
            });
            
            // Fallback to periodic saving
            const saveInterval = setInterval(saveTime, 5000);
            player.on('destroy', () => clearInterval(saveInterval));
        }

        setButtonLinks();

        try {
            const res = await fetch(`/details/${encoded}`);
            if (!res.ok) throw new Error('details fetch failed');
            const data = await res.json();

            // filename: make breakable & keep title as original
            const originalName = data.file_name || rawFile;
            const breakable = makeBreakableName(originalName);
            fileNameEl.innerText = breakable;
            fileNameEl.title = originalName;

            document.getElementById('file-size').innerText = data.file_size || '';

            await checkStreamAndPlay(data);
        } catch (err) {
            console.error('Failed to get file details:', err);
            const fallback = makeBreakableName(rawFile);
            fileNameEl.innerText = fallback;
            fileNameEl.title = rawFile;
            loadingEl.innerText = 'Error: Could not load file details.';
            loadingEl.style.display = 'block';
        }
    })();
    </script>
</body>
</html>
